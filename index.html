<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Wheel Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Plus, TrendingUp, DollarSign, Target, Calendar, Edit2, Check, X } = lucide;

        const OptionsWheelTracker = () => {
          const [trades, setTrades] = useState([]);
          const [showForm, setShowForm] = useState(false);
          const [editingTrade, setEditingTrade] = useState(null);
          const [sheetUrl, setSheetUrl] = useState('');
          const [sheetConfigured, setSheetConfigured] = useState(false);
          const [apiKey, setApiKey] = useState('');
          const [sheetId, setSheetId] = useState('');
          const [loading, setLoading] = useState(false);

          // Load saved credentials on startup
          useEffect(() => {
            const savedUrl = localStorage.getItem('optionsTracker_sheetUrl');
            const savedApiKey = localStorage.getItem('optionsTracker_apiKey');
            
            if (savedUrl && savedApiKey) {
              setSheetUrl(savedUrl);
              setApiKey(savedApiKey);
              const extractedId = extractSheetId(savedUrl);
              if (extractedId) {
                setSheetId(extractedId);
                setSheetConfigured(true);
                setTimeout(() => {
                  loadFromGoogleSheets();
                }, 500);
              }
            }
          }, []);

          const [formData, setFormData] = useState({
            symbol: '',
            currentPrice: '',
            strategy: 'put',
            strike: '',
            premium: '',
            expiration: '',
            quantity: '1',
            status: 'active',
            notes: '',
            openDate: new Date().toISOString().split('T')[0],
            closeDate: '',
            closePrice: ''
          });

          const extractSheetId = (url) => {
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
          };

          const loadFromGoogleSheets = async () => {
            if (!apiKey || !sheetId) return;
            setLoading(true);
            try {
              const range = 'Sheet1!A:M';
              const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`
              );
              
              if (!response.ok) throw new Error('Failed to fetch data');

              const data = await response.json();
              const rows = data.values || [];
              
              if (rows.length > 1) {
                const tradesFromSheet = rows.slice(1).map((row, index) => ({
                  id: index + 1,
                  symbol: row[0] || '',
                  strategy: row[1] || 'put',
                  currentPrice: parseFloat(row[2]) || 0,
                  strike: parseFloat(row[3]) || 0,
                  premium: parseFloat(row[4]) || 0,
                  expiration: row[5] || '',
                  quantity: parseInt(row[6]) || 1,
                  status: row[7] || 'active',
                  openDate: row[8] || '',
                  closeDate: row[9] || '',
                  closePrice: row[10] ? parseFloat(row[10]) : '',
                  notes: row[11] || ''
                })).filter(trade => trade.symbol);
                setTrades(tradesFromSheet);
              }
            } catch (error) {
              alert('Error loading from Google Sheets: ' + error.message);
            }
            setLoading(false);
          };

          const saveToGoogleSheets = async (newTrades = trades) => {
            if (!apiKey || !sheetId) return;
            setLoading(true);
            try {
              const headers = ['Symbol', 'Strategy', 'Current Price', 'Strike', 'Premium', 'Expiration', 'Quantity', 'Status', 'Open Date', 'Close Date', 'Close Price', 'Notes'];
              const rows = [headers, ...newTrades.map(trade => [
                trade.symbol, trade.strategy, trade.currentPrice, trade.strike, trade.premium,
                trade.expiration, trade.quantity, trade.status, trade.openDate, trade.closeDate,
                trade.closePrice || '', trade.notes
              ])];

              const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!A:M?valueInputOption=RAW&key=${apiKey}`,
                {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ values: rows })
                }
              );

              if (!response.ok) throw new Error('Failed to save');
              alert('Data saved successfully!');
            } catch (error) {
              alert('Error saving: ' + error.message);
            }
            setLoading(false);
          };

          const handleInputChange = (e) => {
            setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
          };

          const calculatePnL = (trade) => {
            if (trade.status === 'active') return 0;
            const premiumReceived = trade.premium * trade.quantity * 100;
            const premiumPaid = trade.closePrice ? trade.closePrice * trade.quantity * 100 : 0;
            return premiumReceived - premiumPaid;
          };

          const calculateTotalPnL = () => trades.reduce((total, trade) => total + calculatePnL(trade), 0);

          const getWinRate = () => {
            const closedTrades = trades.filter(t => t.status === 'closed');
            if (closedTrades.length === 0) return 0;
            const winningTrades = closedTrades.filter(t => calculatePnL(t) > 0);
            return ((winningTrades.length / closedTrades.length) * 100).toFixed(1);
          };

          const handleSubmit = () => {
            const newTrade = {
              id: editingTrade ? editingTrade.id : Date.now(),
              ...formData,
              currentPrice: parseFloat(formData.currentPrice),
              strike: parseFloat(formData.strike),
              premium: parseFloat(formData.premium),
              quantity: parseInt(formData.quantity),
              closePrice: formData.closePrice ? parseFloat(formData.closePrice) : ''
            };

            let updatedTrades;
            if (editingTrade) {
              updatedTrades = trades.map(t => t.id === editingTrade.id ? newTrade : t);
              setEditingTrade(null);
            } else {
              updatedTrades = [...trades, newTrade];
            }
            
            setTrades(updatedTrades);
            if (sheetConfigured) saveToGoogleSheets(updatedTrades);

            setFormData({
              symbol: '', currentPrice: '', strategy: 'put', strike: '', premium: '',
              expiration: '', quantity: '1', status: 'active', notes: '',
              openDate: new Date().toISOString().split('T')[0], closeDate: '', closePrice: ''
            });
            setShowForm(false);
          };

          const startEdit = (trade) => {
            setFormData({
              ...trade,
              currentPrice: trade.currentPrice.toString(),
              strike: trade.strike.toString(),
              premium: trade.premium.toString(),
              quantity: trade.quantity.toString(),
              closePrice: trade.closePrice ? trade.closePrice.toString() : ''
            });
            setEditingTrade(trade);
            setShowForm(true);
          };

          const configureSheet = () => {
            const extractedId = extractSheetId(sheetUrl);
            if (extractedId && apiKey) {
              setSheetId(extractedId);
              setSheetConfigured(true);
              localStorage.setItem('optionsTracker_sheetUrl', sheetUrl);
              localStorage.setItem('optionsTracker_apiKey', apiKey);
              loadFromGoogleSheets();
            } else {
              alert('Please enter both URL and API key');
            }
          };

          return (
            <div className="min-h-screen bg-gray-50 p-6">
              <div className="max-w-7xl mx-auto">
                <div className="mb-8">
                  <h1 className="text-3xl font-bold text-gray-900 mb-2">Options Wheel Tracker</h1>
                  <p className="text-gray-600">Track your cash-secured puts and covered calls</p>
                </div>

                {!sheetConfigured && (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <h3 className="text-lg font-semibold text-blue-900 mb-3">Connect Google Sheets</h3>
                    <div className="space-y-4">
                      <div>
                        <label className="block text-blue-700 mb-2">Google Sheets URL:</label>
                        <input
                          type="url"
                          placeholder="https://docs.google.com/spreadsheets/d/..."
                          className="w-full px-3 py-2 border border-blue-300 rounded-md"
                          value={sheetUrl}
                          onChange={(e) => setSheetUrl(e.target.value)}
                        />
                      </div>
                      <div>
                        <label className="block text-blue-700 mb-2">API Key:</label>
                        <input
                          type="password"
                          placeholder="Your Google Sheets API Key"
                          className="w-full px-3 py-2 border border-blue-300 rounded-md"
                          value={apiKey}
                          onChange={(e) => setApiKey(e.target.value)}
                        />
                      </div>
                      <button
                        onClick={configureSheet}
                        disabled={loading}
                        className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                      >
                        {loading ? 'Connecting...' : 'Connect'}
                      </button>
                    </div>
                  </div>
                )}

                {sheetConfigured && (
                  <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <div className="flex justify-between items-center">
                      <div>
                        <h3 className="text-lg font-semibold text-green-900">Sheet Connected</h3>
                        <p className="text-green-700">ID: {sheetId}</p>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={loadFromGoogleSheets} className="px-3 py-1 bg-green-600 text-white rounded">Refresh</button>
                        <button onClick={() => saveToGoogleSheets()} className="px-3 py-1 bg-blue-600 text-white rounded">Save</button>
                        <button 
                          onClick={() => {
                            setSheetConfigured(false);
                            setTrades([]);
                            localStorage.clear();
                            setSheetUrl('');
                            setApiKey('');
                          }}
                          className="px-3 py-1 bg-gray-600 text-white rounded"
                        >
                          Disconnect
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                  <div className="bg-white p-6 rounded-lg shadow border">
                    <div className="flex justify-between items-center">
                      <div>
                        <p className="text-sm text-gray-600">Total P&L</p>
                        <p className={`text-2xl font-bold ${calculateTotalPnL() >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                          ${calculateTotalPnL().toFixed(2)}
                        </p>
                      </div>
                    </div>
                  </div>
                  <div className="bg-white p-6 rounded-lg shadow border">
                    <div className="flex justify-between items-center">
                      <div>
                        <p className="text-sm text-gray-600">Win Rate</p>
                        <p className="text-2xl font-bold text-blue-600">{getWinRate()}%</p>
                      </div>
                    </div>
                  </div>
                  <div className="bg-white p-6 rounded-lg shadow border">
                    <div className="flex justify-between items-center">
                      <div>
                        <p className="text-sm text-gray-600">Active Trades</p>
                        <p className="text-2xl font-bold text-purple-600">{trades.filter(t => t.status === 'active').length}</p>
                      </div>
                    </div>
                  </div>
                  <div className="bg-white p-6 rounded-lg shadow border">
                    <div className="flex justify-between items-center">
                      <div>
                        <p className="text-sm text-gray-600">Total Trades</p>
                        <p className="text-2xl font-bold text-gray-900">{trades.length}</p>
                      </div>
                    </div>
                  </div>
                </div>

                <button
                  onClick={() => setShowForm(!showForm)}
                  className="mb-6 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                >
                  + Add New Trade
                </button>

                {showForm && (
                  <div className="bg-white p-6 rounded-lg shadow mb-8">
                    <h3 className="text-lg font-semibold mb-4">{editingTrade ? 'Edit' : 'Add'} Trade</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <input name="symbol" placeholder="Symbol" value={formData.symbol} onChange={handleInputChange} className="px-3 py-2 border rounded" />
                      <select name="strategy" value={formData.strategy} onChange={handleInputChange} className="px-3 py-2 border rounded">
                        <option value="put">Cash-Secured Put</option>
                        <option value="covered_call">Covered Call</option>
                      </select>
                      <input name="currentPrice" type="number" step="0.01" placeholder="Current Price" value={formData.currentPrice} onChange={handleInputChange} className="px-3 py-2 border rounded" />
                      <input name="strike" type="number" step="0.01" placeholder="Strike" value={formData.strike} onChange={handleInputChange} className="px-3 py-2 border rounded" />
                      <input name="premium" type="number" step="0.01" placeholder="Premium" value={formData.premium} onChange={handleInputChange} className="px-3 py-2 border rounded" />
                      <input name="expiration" type="date" value={formData.expiration} onChange={handleInputChange} className="px-3 py-2 border rounded" />
                      <input name="quantity" type="number" min="1" value={formData.quantity} onChange={handleInputChange} className="px-3 py-2 border rounded" />
                      <select name="status" value={formData.status} onChange={handleInputChange} className="px-3 py-2 border rounded">
                        <option value="active">Active</option>
                        <option value="closed">Closed</option>
                        <option value="assigned">Assigned</option>
                        <option value="expired">Expired</option>
                      </select>
                      <input name="openDate" type="date" value={formData.openDate} onChange={handleInputChange} className="px-3 py-2 border rounded" />
                      {formData.status === 'closed' && (
                        <>
                          <input name="closeDate" type="date" value={formData.closeDate} onChange={handleInputChange} className="px-3 py-2 border rounded" />
                          <input name="closePrice" type="number" step="0.01" placeholder="Close Price" value={formData.closePrice} onChange={handleInputChange} className="px-3 py-2 border rounded" />
                        </>
                      )}
                      <textarea name="notes" placeholder="Notes" value={formData.notes} onChange={handleInputChange} className="md:col-span-3 px-3 py-2 border rounded" rows="2"></textarea>
                      <div className="md:col-span-3 flex gap-3">
                        <button onClick={handleSubmit} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                          {editingTrade ? 'Update' : 'Add'} Trade
                        </button>
                        <button onClick={() => {setShowForm(false); setEditingTrade(null);}} className="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {trades.length > 0 && (
                  <div className="bg-white rounded-lg shadow overflow-hidden">
                    <div className="px-6 py-4 border-b">
                      <h3 className="text-lg font-semibold">Trade History</h3>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Symbol</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Strategy</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Strike</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Premium</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">P&L</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y">
                          {trades.map((trade) => (
                            <tr key={trade.id}>
                              <td className="px-6 py-4 font-medium">{trade.symbol}</td>
                              <td className="px-6 py-4">
                                <span className={`px-2 py-1 text-xs rounded-full ${trade.strategy === 'put' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}`}>
                                  {trade.strategy === 'put' ? 'Put' : 'Call'}
                                </span>
                              </td>
                              <td className="px-6 py-4">${trade.strike}</td>
                              <td className="px-6 py-4">${trade.premium}</td>
                              <td className="px-6 py-4">
                                <span className={`px-2 py-1 text-xs rounded-full ${
                                  trade.status === 'active' ? 'bg-yellow-100 text-yellow-800' :
                                  trade.status === 'closed' ? 'bg-green-100 text-green-800' :
                                  'bg-gray-100 text-gray-800'
                                }`}>
                                  {trade.status}
                                </span>
                              </td>
                              <td className={`px-6 py-4 font-medium ${calculatePnL(trade) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trade.status === 'active' ? '-' : `$${calculatePnL(trade).toFixed(2)}`}
                              </td>
                              <td className="px-6 py-4">
                                <button onClick={() => startEdit(trade)} className="text-blue-600 hover:text-blue-900">Edit</button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {trades.length === 0 && (
                  <div className="text-center py-12">
                    <p className="text-gray-500">Connect your Google Sheet and start tracking trades!</p>
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<OptionsWheelTracker />, document.getElementById('root'));
    </script>
</body>
</html>
